version: "3.8"

services:
  redis:
    image: redis:7-alpine
    container_name: moodle_redis
    command: ["redis-server", "--requirepass", "${REDIS_PASSWORD}"]
    volumes:
      - redis_data:/data
    # Porta não exposta externamente - apenas acesso interno via rede Docker
    restart: unless-stopped
    networks:
      - moodle_net

  # Faz o clone do Moodle para dentro do volume (na primeira execução)
  moodle-init:
    image: alpine/git:2.45.2
    container_name: moodle_init
    environment:
      - MOODLE_GIT_BRANCH=${MOODLE_GIT_BRANCH:-MOODLE_404_STABLE}
      - MOODLE_GIT_URL=${MOODLE_GIT_URL:-https://github.com/moodle/moodle.git}
    volumes:
      - moodle_www:/var/www/html
    entrypoint: ["/bin/sh", "-c"]
    command: >
      "
      set -e;
      if [ -f /var/www/html/version.php ] && [ -f /var/www/html/lib/phpminimumversionlib.php ] && [ -d /var/www/html/lib ]; then
        echo 'Moodle já existe e está completo no volume. Pulando clone.';
        exit 0;
      fi;
      echo 'Moodle incompleto ou corrompido detectado. Limpando completamente...';
      if [ -d /var/www/html ]; then
        cd /var/www/html;
        rm -rf .git 2>/dev/null || true;
        find . -mindepth 1 -maxdepth 1 -exec rm -rf {} + 2>/dev/null || true;
        rm -rf * .[!.]* ..?* 2>/dev/null || true;
      fi;
      echo 'Clonando Moodle ($${MOODLE_GIT_BRANCH:-MOODLE_404_STABLE})...';
      TEMP_DIR=\"/tmp/moodle-$$\";
      git clone --depth 1 --branch \"$${MOODLE_GIT_BRANCH:-MOODLE_404_STABLE}\" \"$${MOODLE_GIT_URL:-https://github.com/moodle/moodle.git}\" \"$${TEMP_DIR}\";
      cp -r \"$${TEMP_DIR}\"/. /var/www/html/ 2>/dev/null || cp -r \"$${TEMP_DIR}\"/* /var/www/html/;
      rm -rf \"$${TEMP_DIR}\";
      echo 'Clone finalizado. Verificando instalação...';
      if [ ! -f /var/www/html/version.php ]; then
        echo 'ERRO: version.php não encontrado após clone!';
        exit 1;
      fi;
      if [ ! -f /var/www/html/lib/phpminimumversionlib.php ]; then
        echo 'ERRO: lib/phpminimumversionlib.php não encontrado após clone!';
        exit 1;
      fi;
      if [ ! -d /var/www/html/lib ]; then
        echo 'ERRO: Diretório lib/ não encontrado após clone!';
        exit 1;
      fi;
      echo 'Instalação verificada com sucesso.';
      "
    restart: "no"
    networks:
      - moodle_net

  moodle-web:
    image: moodlehq/moodle-php-apache:8.2-bookworm
    container_name: moodle_app
    depends_on:
      - moodle-init
      - redis
    environment:
      # URL pública (domínio)
      - MOODLE_HOST=${MOODLE_HOST}
      - MOODLE_WWWROOT=https://${MOODLE_HOST}
      # Configurações para proxy reverso (Traefik)
      - MOODLE_REVERSEPROXY=true
      - MOODLE_SSLPROXY=true

      # DB (PostgreSQL externo compartilhado)
      - MOODLE_DBTYPE=pgsql
      - MOODLE_DBHOST=${POSTGRES_HOST}
      - MOODLE_DBPORT=${POSTGRES_PORT:-5432}
      - MOODLE_DBNAME=${POSTGRES_DATABASE}
      - MOODLE_DBUSER=${POSTGRES_USER}
      - MOODLE_DBPASS=${POSTGRES_PASSWORD}

      # Redis (cache/sessões)
      - MOODLE_REDIS_HOST=redis
      - MOODLE_REDIS_PORT=6379
      - MOODLE_REDIS_PASSWORD=${REDIS_PASSWORD}

      # Ajustes úteis para produção
      - PHP_MEMORY_LIMIT=512M
      - PHP_MAX_EXECUTION_TIME=300
      - PHP_POST_MAX_SIZE=128M
      - PHP_UPLOAD_MAX_FILESIZE=128M

    volumes:
      - moodle_www:/var/www/html
      - moodledata:/var/www/moodledata
    restart: unless-stopped
    networks:
      - moodle_net
      - gwan

    labels:
      # Traefik configuration
      - "traefik.enable=true"
      - "traefik.docker.network=gwan"
      
      # HTTPS Router (apenas HTTPS, sem HTTP)
      - "traefik.http.routers.moodle-backend.rule=Host(`${MOODLE_HOST}`)"
      - "traefik.http.routers.moodle-backend.entrypoints=websecure"
      - "traefik.http.routers.moodle-backend.tls=true"
      - "traefik.http.routers.moodle-backend.tls.certresolver=letsencrypt"
      - "traefik.http.routers.moodle-backend.service=moodle-backend"
      - "traefik.http.routers.moodle-backend.middlewares=moodle-headers"
      
      # Middleware para headers corretos do proxy reverso
      - "traefik.http.middlewares.moodle-headers.headers.customrequestheaders.X-Forwarded-Proto=https"
      - "traefik.http.middlewares.moodle-headers.headers.customrequestheaders.X-Forwarded-Host=${MOODLE_HOST}"
      - "traefik.http.middlewares.moodle-headers.headers.customrequestheaders.X-Forwarded-Port=443"
      - "traefik.http.middlewares.moodle-headers.headers.customrequestheaders.X-Forwarded-Ssl=on"
      
      # Service configuration
      - "traefik.http.services.moodle-backend.loadbalancer.server.port=80"
      - "traefik.http.services.moodle-backend.loadbalancer.passHostHeader=true"

  # Cron do Moodle (recomendado)
  moodle-cron:
    image: moodlehq/moodle-php-apache:8.2-bookworm
    container_name: moodle_cron
    depends_on:
      - moodle-web
    volumes:
      - moodle_www:/var/www/html
      - moodledata:/var/www/moodledata
    entrypoint: ["/bin/sh", "-lc"]
    command: >
      '
      while true; do
        php /var/www/html/admin/cli/cron.php || true;
        sleep 60;
      done
      '
    restart: unless-stopped
    networks:
      - moodle_net

volumes:
  redis_data:
  moodle_www:
  moodledata:

networks:
  moodle_net:
    driver: bridge
  gwan:
    external: true
