version: "3.8"

services:
  postgres:
    image: postgres:15-alpine
    container_name: moodle_postgres_local
    environment:
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: ${POSTGRES_DATABASE}
      POSTGRES_USER: ${POSTGRES_USER}
      PGDATA: /var/lib/postgresql/data/pgdata
    volumes:
      - postgres_data_local:/var/lib/postgresql/data
    ports:
      - "5432:5432"
    restart: unless-stopped
    networks:
      - moodle_net_local

  redis:
    image: redis:7-alpine
    container_name: moodle_redis_local
    command: ["redis-server", "--requirepass", "${REDIS_PASSWORD}"]
    volumes:
      - redis_data_local:/data
    ports:
      - "6379:6379"
    restart: unless-stopped
    networks:
      - moodle_net_local

  # Faz o clone do Moodle para dentro do volume (na primeira execução)
  moodle-init:
    image: alpine/git:2.45.2
    container_name: moodle_init_local
    depends_on:
      - postgres
    environment:
      - MOODLE_GIT_BRANCH=${MOODLE_GIT_BRANCH:-MOODLE_404_STABLE}
      - MOODLE_GIT_URL=${MOODLE_GIT_URL:-https://github.com/moodle/moodle.git}
    volumes:
      - moodle_www_local:/var/www/html
    entrypoint: ["/bin/sh", "-lc"]
    command: >
      '
      set -e;
      if [ -f /var/www/html/version.php ]; then
        echo "Moodle já existe no volume. Pulando clone.";
        exit 0;
      fi;
      echo "Clonando Moodle ($${MOODLE_GIT_BRANCH})...";
      git clone --depth 1 --branch "$${MOODLE_GIT_BRANCH}" "$${MOODLE_GIT_URL}" /var/www/html;
      echo "Clone finalizado.";
      '
    restart: "no"
    networks:
      - moodle_net_local

  moodle-web:
    image: moodlehq/moodle-php-apache:8.2-bookworm
    container_name: moodle_web_local
    depends_on:
      - moodle-init
      - postgres
      - redis
    ports:
      - "8080:80"
    environment:
      # Use localhost no dev
      - MOODLE_HOST=${MOODLE_HOST:-localhost}
      - MOODLE_WWWROOT=${MOODLE_WWWROOT:-http://localhost:8080}

      # DB (Moodle vai pedir isso no instalador web; também serve para referência)
      - MOODLE_DBTYPE=pgsql
      - MOODLE_DBHOST=postgres
      - MOODLE_DBNAME=${POSTGRES_DATABASE}
      - MOODLE_DBUSER=${POSTGRES_USER}
      - MOODLE_DBPASS=${POSTGRES_PASSWORD}

      # Redis (você configurará no config.php após instalar)
      - MOODLE_REDIS_HOST=redis
      - MOODLE_REDIS_PORT=6379
      - MOODLE_REDIS_PASSWORD=${REDIS_PASSWORD}

    volumes:
      - moodle_www_local:/var/www/html
      - moodledata_local:/var/www/moodledata
    restart: unless-stopped
    networks:
      - moodle_net_local

  # Cron do Moodle (recomendado)
  moodle-cron:
    image: moodlehq/moodle-php-apache:8.2-bookworm
    container_name: moodle_cron_local
    depends_on:
      - moodle-web
    volumes:
      - moodle_www_local:/var/www/html
      - moodledata_local:/var/www/moodledata
    entrypoint: ["/bin/sh", "-lc"]
    command: >
      '
      while true; do
        php /var/www/html/admin/cli/cron.php || true;
        sleep 60;
      done
      '
    restart: unless-stopped
    networks:
      - moodle_net_local

volumes:
  postgres_data_local:
  redis_data_local:
  moodle_www_local:
  moodledata_local:

networks:
  moodle_net_local:
    driver: bridge
